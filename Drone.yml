---
tipo : pipeline
tipo : docker
nome : k8s-cluster

passos :
      
- name : inicializa o plugin aws para terraform
  imagem : mateusmuller2/ansibleandterraform:latest
  ambiente :
    AWS_ACCESS_KEY_ID :
      from_secret : aws_access
    AWS_SECRET_ACCESS_KEY :
      from_secret : aws_secret
  comandos :
  - inicialização do terraform
  
- name : cria aws infra
  imagem : mlaurawferreira/ansibleandterraform:latest
  ambiente :
    AWS_ACCESS_KEY_ID :
      from_secret : aws_access
    AWS_SECRET_ACCESS_KEY :
      from_secret : aws_secret
  comandos :
  - aplicação terraform -auto-aprovação
  
- name : aplique o playbook ansible
  imagem : mlaurawferreira/ansibleandterraform:latest
  ambiente :
    AWS_ACCESS_KEY_ID :
      from_secret : aws_access
    AWS_SECRET_ACCESS_KEY :
      from_secret : aws_secret
    PRIVATE_KEY :
      from_secret : private_key
  comandos :
    -mkdir -p ~ /.ssh/
    - echo "$PRIVATE_KEY" > ~/.ssh/id_rsa
    - desabilitar PRIVATE_KEY
    - chmod 600 ~/.ssh/id_rsa
    - ansible-playbook -i ec2.py --limit "tag_name_k8s" -u ubuntu --ssh-common-args='-o StrictHostKeyChecking=no' --private-key ~/.ssh/id_rsa site.yml
